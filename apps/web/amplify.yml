version: 1
applications:
  - env:
      variables:
        HUGO_VERSION: 0.134.2
    backend:
      phases:
        build:
          commands:
            - echo "Output environment variables"
            - echo HUGO_VERSION $HUGO_VERSION
            - echo AWS_APP_ID $AWS_APP_ID
            - 'npm ci --cache .npm --prefer-offline', 'npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID'
    frontend:
      phases:
        install:
          commands:
            - echo hugo version is ${HUGO_VERSION}
            - curl -Ls https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_Linux-64bit.tar.gz -o /tmp/hugo.tar.gz
            - tar zxf /tmp/hugo.tar.gz -C /tmp
            - mv /tmp/hugo /usr/local/bin/hugo
            - rm -rf /tmp/hugo*
        build:
          commands: ['npm run build']
      artifacts:
        baseDirectory: public
        files:
          - '**/*'
      cache:
        paths:
          - '.npm/**/*'
    appRoot: apps/web
